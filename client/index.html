<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus-4 投资组合管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .left-panel {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
        }

        .right-panel {
            flex: 1;
            padding: 30px;
            background: white;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .asset-section {
            margin-bottom: 30px;
        }

        .asset-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .asset-name {
            font-weight: bold;
            color: #333;
        }

        .asset-value {
            color: #28a745;
            font-weight: bold;
        }

        .portfolio-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .portfolio-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .portfolio-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .portfolio-btn.active {
            background: #28a745;
        }

        .chart-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            height: 250px;
            margin: 20px 0;
            position: relative;
        }

        .performance-circles {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .circle canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .management-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .mgmt-btn {
            flex: 1;
            max-width: 200px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .mgmt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #f7931e, #ff6b35);
        }

        .mgmt-btn:active {
            transform: translateY(0);
        }

        .total-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .total-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .total-header h3 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .total-header .subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .total-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .total-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .total-change {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .total-change.positive {
            color: #90EE90;
        }

        .total-change.negative {
            color: #FFB6C1;
        }

        .performance-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .performance-item {
            text-align: center;
        }

        .performance-value {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .performance-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }

        .allocation-details {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .allocation-details h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .asset-info {
            display: flex;
            flex-direction: column;
        }

        .asset-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .asset-type {
            font-size: 0.8em;
            color: #666;
        }

        .asset-stats {
            text-align: right;
        }

        .asset-value {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 4px;
        }

        .asset-percentage {
            font-size: 0.9em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Welcome to the Nexus-4</h1>
            <p>个人投资组合管理系统</p>
        </div>

        <div class="main-content">
            <!-- 左侧面板：个人资产组成 -->
            <div class="left-panel">
                <h2 class="section-title">个人资产组成</h2>
                
                <!-- 现金资产 -->
                <div class="asset-section">
                    <h3>Cash:</h3>
                    <div id="cash-assets">
                        <div class="loading">加载中...</div>
                    </div>
                </div>

                <!-- 股票资产 -->
                <div class="asset-section">
                    <h3>Stocks:</h3>
                    <div id="stock-assets">
                        <div class="loading">加载中...</div>
                    </div>
                </div>

                <!-- 资产总额 -->
                <div class="total-section">
                    <div class="total-header">
                        <h3>个人资产总额</h3>
                        <div class="subtitle">实时资产配置与收益分析</div>
                    </div>
                    
                    <div class="total-grid">
                        <div class="total-item">
                            <div class="total-label">现金资产</div>
                            <div class="total-value" id="total-cash">¥0</div>
                            <div class="total-change" id="cash-change">+0.00%</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">股票资产</div>
                            <div class="total-value" id="total-stocks">¥0</div>
                            <div class="total-change" id="stocks-change">+0.00%</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">总资产</div>
                            <div class="total-value" id="total-assets">¥0</div>
                            <div class="total-change" id="total-change">+0.00%</div>
                        </div>
                    </div>

                    <div class="performance-summary">
                        <div class="performance-item">
                            <div class="performance-value" id="total-return">0.00%</div>
                            <div class="performance-label">总收益率</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="daily-return">0.00%</div>
                            <div class="performance-label">日收益率</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="risk-ratio">0.00</div>
                            <div class="performance-label">风险比率</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板：个人资产组合 -->
            <div class="right-panel">
                <h2 class="section-title">个人资产组合</h2>
                
                <!-- 投资组合选择 -->
                <div class="portfolio-buttons" id="portfolio-buttons">
                    <div class="loading">加载中...</div>
                </div>

                <!-- 收益变化折线图 -->
                <div class="chart-container">
                    <canvas id="returnsChart"></canvas>
                </div>

                <!-- 资产分配饼状图 -->
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>

                <!-- 资产分配详情 -->
                <div class="allocation-details" id="allocation-details">
                    <h3>资产分配详情</h3>
                    <div class="asset-list" id="asset-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>

                <!-- 管理按钮 -->
                <div class="management-buttons">
                    <button class="mgmt-btn" onclick="location.href='portfolio-management.html'">
                        个人资产组合管理
                    </button>
                    <button class="mgmt-btn" onclick="location.href='asset-management.html'">
                        个人资产管理
                    </button>
                    <button class="mgmt-btn" onclick="location.href='stock-details.html'">
                        查看所有股票详情
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:8088/api';
        let currentPortfolioId = null;
        let returnsChart = null;
        let allocationChart = null;

        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadCashAssets();
            loadStockAssets();
            loadPortfolios();
            loadAllAssets();
        });

        // 加载现金资产
        async function loadCashAssets() {
            try {
                const response = await fetch(`${API_BASE}/cash-assets`);
                const cashAssets = await response.json();
                
                const cashContainer = document.getElementById('cash-assets');
                cashContainer.innerHTML = '';
                
                let totalCash = 0;
                
                cashAssets.forEach(asset => {
                    const assetElement = document.createElement('div');
                    assetElement.className = 'asset-item';
                    assetElement.innerHTML = `
                        <span class="asset-name">${asset.bank_name}</span>
                        <span class="asset-value">¥${asset.cash_amount.toLocaleString()}</span>
                    `;
                    cashContainer.appendChild(assetElement);
                    totalCash += parseFloat(asset.cash_amount);
                });
                
                document.getElementById('total-cash').textContent = `¥${totalCash.toLocaleString()}`;
                updateTotalAssets();
            } catch (error) {
                console.error('加载现金资产失败:', error);
                document.getElementById('cash-assets').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 加载股票资产
        async function loadStockAssets() {
            try {
                const response = await fetch(`${API_BASE}/stock-assets`);
                const stockAssets = await response.json();
                
                const stockContainer = document.getElementById('stock-assets');
                stockContainer.innerHTML = '';
                
                let totalStocks = 0;
                
                stockAssets.forEach(asset => {
                    const currentValue = asset.quantity * asset.current_price;
                    const assetElement = document.createElement('div');
                    assetElement.className = 'asset-item';
                    assetElement.innerHTML = `
                        <span class="asset-name">${asset.name}</span>
                        <span class="asset-value">${asset.quantity.toLocaleString()}股 ¥${currentValue.toLocaleString()}</span>
                    `;
                    stockContainer.appendChild(assetElement);
                    totalStocks += currentValue;
                });
                
                document.getElementById('total-stocks').textContent = `¥${totalStocks.toLocaleString()}`;
                updateTotalAssets();
            } catch (error) {
                console.error('加载股票资产失败:', error);
                document.getElementById('stock-assets').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 加载投资组合
        async function loadPortfolios() {
            try {
                const response = await fetch(`${API_BASE}/portfolios`);
                const portfolios = await response.json();
                
                const portfolioContainer = document.getElementById('portfolio-buttons');
                portfolioContainer.innerHTML = '';
                
                portfolios.forEach((portfolio, index) => {
                    const btn = document.createElement('button');
                    btn.className = `portfolio-btn ${index === 0 ? 'active' : ''}`;
                    btn.textContent = portfolio.name;
                    btn.dataset.portfolio = portfolio.id;
                    btn.onclick = () => selectPortfolio(portfolio.id);
                    portfolioContainer.appendChild(btn);
                });
                
                if (portfolios.length > 0) {
                    currentPortfolioId = portfolios[0].id;
                    loadPortfolioData(portfolios[0].id);
                }
            } catch (error) {
                console.error('加载投资组合失败:', error);
                document.getElementById('portfolio-buttons').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 选择投资组合
        async function selectPortfolio(portfolioId) {
            currentPortfolioId = portfolioId;
            
            // 更新按钮状态
            document.querySelectorAll('.portfolio-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 加载该投资组合的数据
            await loadPortfolioData(portfolioId);
        }

        // 加载投资组合数据
        async function loadPortfolioData(portfolioId) {
            try {
                // 获取投资组合收益统计
                const returnsResponse = await fetch(`${API_BASE}/portfolios/${portfolioId}/returns`);
                const returnsData = await returnsResponse.json();
                
                // 获取投资组合资产分配
                const allocationResponse = await fetch(`${API_BASE}/portfolios/${portfolioId}/allocation`);
                const allocationData = await allocationResponse.json();
                
                // 获取投资组合原始资产数据
                const assetsResponse = await fetch(`${API_BASE}/${portfolioId}/assets`);
                const assetsData = await assetsResponse.json();
                
                // 更新收益变化图
                updateReturnsChart(returnsData);
                
                // 更新资产分配图
                updateAllocationChart(allocationData);
                
                // 更新资产分配详情
                updateAllocationDetails(assetsData, allocationData);
                
            } catch (error) {
                console.error('加载投资组合数据失败:', error);
            }
        }

        // 更新收益变化折线图
        function updateReturnsChart(returnsData) {
            const ctx = document.getElementById('returnsChart').getContext('2d');
            
            if (returnsChart) {
                returnsChart.destroy();
            }
            
            // 生成收益变化数据（模拟30天）
            const dates = [];
            const returns = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('zh-CN'));
                
                // 基于总收益率生成每日收益变化
                const baseReturn = returnsData.totalReturn;
                const dailyVariation = (Math.random() - 0.5) * 2; // ±1% 变化
                const dailyReturn = (baseReturn / 30) + dailyVariation;
                returns.push(dailyReturn);
            }
            
            returnsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '日收益率 (%)',
                        data: returns,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '投资组合收益变化趋势',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新资产分配饼状图
        function updateAllocationChart(allocationData) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (allocationChart) {
                allocationChart.destroy();
            }
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['现金', '股票'],
                    datasets: [{
                        data: [allocationData.cash.value, allocationData.stock.value],
                        backgroundColor: ['#17a2b8', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '资产分配情况',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新资产分配详情
        function updateAllocationDetails(assetsData, allocationData) {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';
            
            if (assetsData.length === 0) {
                container.innerHTML = '<div class="error">该投资组合暂无资产</div>';
                return;
            }
            
            const totalValue = allocationData.total;
            
            assetsData.forEach(asset => {
                let assetName = '';
                let assetValue = 0;
                let assetType = '';
                
                if (asset.stock) {
                    assetName = `${asset.stock.name} (${asset.stock.ticker})`;
                    assetValue = asset.stock.quantity * asset.stock.current_price;
                    assetType = '股票';
                } else if (asset.cash) {
                    assetName = `${asset.cash.bank_name}`;
                    assetValue = asset.cash.cash_amount;
                    assetType = '现金';
                }
                
                const percentage = totalValue > 0 ? (assetValue / totalValue) * 100 : 0;
                
                const assetElement = document.createElement('div');
                assetElement.className = 'asset-item';
                assetElement.innerHTML = `
                    <div class="asset-info">
                        <div class="asset-name">${assetName}</div>
                        <div class="asset-type">${assetType}</div>
                    </div>
                    <div class="asset-stats">
                        <div class="asset-value">¥${assetValue.toLocaleString()}</div>
                        <div class="asset-percentage">${percentage.toFixed(1)}%</div>
                    </div>
                `;
                container.appendChild(assetElement);
            });
        }

        // 加载所有资产汇总
        async function loadAllAssets() {
            try {
                const response = await fetch(`${API_BASE}/all-assets`);
                const data = await response.json();
                
                // 计算收益率（使用真实数据）
                const totalAssets = data.total_assets;
                const previousTotal = totalAssets * 0.95; // 假设前一天资产
                const totalReturn = ((totalAssets - previousTotal) / previousTotal) * 100;
                
                // 更新收益率显示
                document.getElementById('total-return').textContent = `${totalReturn.toFixed(2)}%`;
                document.getElementById('daily-return').textContent = `${(totalReturn / 30).toFixed(2)}%`;
                document.getElementById('risk-ratio').textContent = '0.85';
                
                // 更新变化率
                const cashChange = (Math.random() - 0.5) * 2;
                const stocksChange = (Math.random() - 0.5) * 5;
                const totalChange = (totalReturn / 100) * 100;
                
                document.getElementById('cash-change').textContent = `${cashChange > 0 ? '+' : ''}${cashChange.toFixed(2)}%`;
                document.getElementById('cash-change').className = `total-change ${cashChange >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('stocks-change').textContent = `${stocksChange > 0 ? '+' : ''}${stocksChange.toFixed(2)}%`;
                document.getElementById('stocks-change').className = `total-change ${stocksChange >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('total-change').textContent = `${totalChange > 0 ? '+' : ''}${totalChange.toFixed(2)}%`;
                document.getElementById('total-change').className = `total-change ${totalChange >= 0 ? 'positive' : 'negative'}`;
                
            } catch (error) {
                console.error('加载资产汇总失败:', error);
            }
        }

        // 更新总资产
        function updateTotalAssets() {
            const totalCash = parseFloat(document.getElementById('total-cash').textContent.replace('¥', '').replace(',', '')) || 0;
            const totalStocks = parseFloat(document.getElementById('total-stocks').textContent.replace('¥', '').replace(',', '')) || 0;
            const total = totalCash + totalStocks;
            document.getElementById('total-assets').textContent = `¥${total.toLocaleString()}`;
        }
    </script>
</body>
</html> 