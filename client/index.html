<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus-4 Portfolio Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* 管理按钮区域样式 */
        .management-section {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .management-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px;
        }

        .mgmt-btn {
            flex: 1;
            max-width: 200px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .mgmt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #f7931e, #ff6b35);
        }

        .mgmt-btn:active {
            transform: translateY(0);
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .left-panel {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
        }

        .right-panel {
            flex: 1;
            padding: 30px;
            background: white;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .asset-section {
            margin-bottom: 30px;
        }

        .asset-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .asset-name {
            font-weight: bold;
            color: #333;
        }

        .asset-value {
            color: #28a745;
            font-weight: bold;
        }

        .portfolio-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .portfolio-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .portfolio-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .portfolio-btn.active {
            background: #28a745;
        }

        .chart-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            height: 250px;
            margin: 20px 0;
            position: relative;
        }

        .performance-circles {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .circle canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .total-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .total-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .total-header h3 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .total-header .subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .total-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .total-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .total-change {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .total-change.positive {
            color: #90EE90;
        }

        .total-change.negative {
            color: #FFB6C1;
        }

        .performance-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .performance-item {
            text-align: center;
        }

        .performance-value {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .performance-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }

        .allocation-details {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .allocation-details h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .asset-info {
            display: flex;
            flex-direction: column;
        }

        .asset-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .asset-type {
            font-size: 0.8em;
            color: #666;
        }

        .asset-stats {
            text-align: right;
        }

        .asset-value {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 4px;
        }

        .asset-percentage {
            font-size: 0.9em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Welcome to the Nexus-4</h1>
            <p>Personal Portfolio Management System</p>
        </div>

        <!-- 管理按钮区域 -->
        <div class="management-section">
            <div class="management-buttons">
                <button class="mgmt-btn" onclick="location.href='portfolio-management.html'">
                    Asset Portfolio
                </button>
                <button class="mgmt-btn" onclick="location.href='asset-management.html'">
                    Personal Asset
                </button>
                <button class="mgmt-btn" onclick="location.href='stock-details.html'">
                    View all stock details
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- 左侧面板：个人资产组成 -->
            <div class="left-panel">
                <!-- 个人资产总额 - 移到左侧面板顶部 -->
                <div class="total-section">
                    <div class="total-header">
                        <h3>Total Personal Assets</h3>
                        <div class="subtitle">Real-time asset allocation and return analysis</div>
                    </div>
                    
                    <div class="total-grid">
                        <div class="total-item">
                            <div class="total-label">Cash Assets</div>
                            <div class="total-value" id="total-cash">$0</div>
                            <div class="total-change" id="cash-change">+0.00%</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Stock Assets</div>
                            <div class="total-value" id="total-stocks">$0</div>
                            <div class="total-change" id="stocks-change">+0.00%</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Total Assets</div>
                            <div class="total-value" id="total-assets">$0</div>
                            <div class="total-change" id="total-change">+0.00%</div>
                        </div>
                    </div>

                    <div class="performance-summary">
                        <div class="performance-item">
                            <div class="performance-value" id="total-return">0.00%</div>
                            <div class="performance-label">Total Rate of Return</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="daily-return">0.00%</div>
                            <div class="performance-label">Daily Rate of Return</div>
                        </div>
<!--                        <div class="performance-item">-->
<!--                            <div class="performance-value" id="risk-ratio">0.00</div>-->
<!--                            <div class="performance-label">风险比率</div>-->
<!--                        </div>-->
                    </div>
                </div>

                <h2 class="section-title">Composition of Personal Assets</h2>
                
                <!-- 现金资产 -->
                <div class="asset-section">
                    <h3>Cash:</h3>
                    <div id="cash-assets">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- 股票资产 -->
                <div class="asset-section">
                    <h3>Stocks:</h3>
                    <div id="stock-assets">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板：个人资产组合 -->
            <div class="right-panel">
                <h2 class="section-title">Personal Asset Portfolio</h2>
                
                <!-- 投资组合选择 -->
                <div class="portfolio-buttons" id="portfolio-buttons">
                    <div class="loading">Loading...</div>
                </div>

                <!-- 收益变化折线图 -->
                <div class="chart-container">
                    <canvas id="returnsChart"></canvas>
                </div>

                <!-- 资产分配饼状图 -->
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>

                <!-- 资产分配详情 -->
                <div class="allocation-details" id="allocation-details">
                    <h3>Asset Allocation Details</h3>
                    <div class="asset-list" id="asset-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:8088/api';
        let currentPortfolioId = null;
        let returnsChart = null;
        let allocationChart = null;

        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadCashAssets();
            loadStockAssets();
            loadPortfolios();
            loadAllAssets();
        });

        // 加载现金资产
        async function loadCashAssets() {
            try {
                const response = await fetch(`${API_BASE}/cash-assets`);
                const cashAssets = await response.json();
                
                const cashContainer = document.getElementById('cash-assets');
                cashContainer.innerHTML = '';
                
                let totalCash = 0;
                
                cashAssets.forEach(asset => {
                    const assetElement = document.createElement('div');
                    assetElement.className = 'asset-item';
                    assetElement.innerHTML = `
                        <span class="asset-name">${asset.bank_name}</span>
                        <span class="asset-value">$${asset.cash_amount.toLocaleString()}</span>
                    `;
                    cashContainer.appendChild(assetElement);
                    totalCash += parseFloat(asset.cash_amount);
                });
                
                document.getElementById('total-cash').textContent = `$${totalCash.toLocaleString()}`;
                updateTotalAssets();
            } catch (error) {
                console.error('Failed to load cash assets:', error);
                document.getElementById('cash-assets').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 加载股票资产
        async function loadStockAssets() {
            try {
                const response = await fetch(`${API_BASE}/stock-assets`);
                const stockAssets = await response.json();
                
                const stockContainer = document.getElementById('stock-assets');
                stockContainer.innerHTML = '';
                
                let totalStocks = 0;
                
                stockAssets.forEach(asset => {
                    const currentValue = asset.quantity * asset.current_price;
                    const assetElement = document.createElement('div');
                    assetElement.className = 'asset-item';
                    assetElement.innerHTML = `
                        <span class="asset-name">${asset.name}</span>
                        <span class="asset-value">Share Count: ${asset.quantity.toLocaleString()}.  $${currentValue.toLocaleString()}</span>
                    `;
                    stockContainer.appendChild(assetElement);
                    totalStocks += currentValue;
                });
                
                document.getElementById('total-stocks').textContent = `$${totalStocks.toLocaleString()}`;
                updateTotalAssets();
            } catch (error) {
                console.error('加载股票资产失败:', error);
                document.getElementById('stock-assets').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 加载投资组合
        async function loadPortfolios() {
            try {
                const response = await fetch(`${API_BASE}/portfolios`);
                const portfolios = await response.json();
                
                const portfolioContainer = document.getElementById('portfolio-buttons');
                portfolioContainer.innerHTML = '';
                
                portfolios.forEach((portfolio, index) => {
                    const btn = document.createElement('button');
                    btn.className = `portfolio-btn ${index === 0 ? 'active' : ''}`;
                    btn.textContent = portfolio.name;
                    btn.dataset.portfolio = portfolio.id;
                    btn.onclick = () => selectPortfolio(portfolio.id);
                    portfolioContainer.appendChild(btn);
                });
                
                if (portfolios.length > 0) {
                    currentPortfolioId = portfolios[0].id;
                    loadPortfolioData(portfolios[0].id);
                }
            } catch (error) {
                console.error('加载投资组合失败:', error);
                document.getElementById('portfolio-buttons').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        // 选择投资组合
        async function selectPortfolio(portfolioId) {
            currentPortfolioId = portfolioId;
            
            // 更新按钮状态
            document.querySelectorAll('.portfolio-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 加载该投资组合的数据
            await loadPortfolioData(portfolioId);
        }

        // 加载投资组合数据
        async function loadPortfolioData(portfolioId) {
            try {
                // 获取投资组合收益统计
                const returnsResponse = await fetch(`${API_BASE}/portfolio-performance/${portfolioId}`);
                const returnsData = await returnsResponse.json();
                
                // 获取投资组合资产分配
                const allocationResponse = await fetch(`${API_BASE}/portfolios/${portfolioId}/allocation`);
                const allocationData = await allocationResponse.json();
                
                // 获取投资组合原始资产数据
                const assetsResponse = await fetch(`${API_BASE}/${portfolioId}/assets`);
                const assetsData = await assetsResponse.json();
                
                // 更新收益变化图
                updateReturnsChart(returnsData);
                
                // 更新资产分配图
                updateAllocationChart(allocationData);
                
                // 更新资产分配详情
                updateAllocationDetails(assetsData, allocationData);
                
            } catch (error) {
                console.error('加载投资组合数据失败:', error);
            }
        }

        // 更新收益变化折线图
        // 传入后台返回的数组
        function updateReturnsChart(returnsData) {
            console.log('更新收益变化图:', returnsData);
            const ctx = document.getElementById('returnsChart').getContext('2d');

            if(returnsChart) {
                returnsChart.destroy();
                returnsChart = null;
            }

            // 如果没有股票资产，显示仅持有现金
            if (!returnsData.stockAssets || returnsData.stockAssets.length === 0) {
                const today = new Date();
                const dates = [];

                // 默认展示近 7 天
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().slice(0, 10));
                }

                const displayDates = dates.map(d => {
                    const dt = new Date(d);
                    return dt.toLocaleDateString('zh-CN');
                });

                const zeroProfits = new Array(dates.length).fill(0);

                returnsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayDates,
                        datasets: [{
                            label: 'Cash Only',
                            data: zeroProfits,
                            borderColor: 'rgba(192, 192, 192, 1)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '收益 (元)' }
                            },
                            x: {
                                title: { display: true, text: '日期' }
                            }
                        }
                    }
                });

                return; // 退出函数
            }

            // 有股票资产时，处理收益数据
            const dateSet = new Set();
            returnsData.stockAssets.forEach(stock => {
                stock.history.forEach(h => {
                    dateSet.add(new Date(h.date).toISOString().slice(0,10));
                });
            });

            const allDates = Array.from(dateSet).sort();

            const totalProfits = allDates.map(dateStr => {
                let dailySum = 0;
                returnsData.stockAssets.forEach(stock => {
                    const entry = stock.history.find(h => h.date.startsWith(dateStr));
                    if (entry) {
                        dailySum += entry.profit;
                    }
                });
                return dailySum;
            });

            const displayDates = allDates.map(d => {
                const dt = new Date(d);
                return dt.toLocaleDateString('zh-CN');
            });

            returnsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayDates,
                    datasets: [{
                        label: 'Portfolio Daily Returns',
                        data: totalProfits,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Revenue ($)' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        }


        // 更新资产分配饼状图
        function updateAllocationChart(allocationData) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (allocationChart) {
                allocationChart.destroy();
            }
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'Stock'],
                    datasets: [{
                        data: [allocationData.cash.value, allocationData.stock.value],
                        backgroundColor: ['#17a2b8', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Asset Allocation',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新资产分配详情
        function updateAllocationDetails(assetsData, allocationData) {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';
            
            if (assetsData.length === 0) {
                container.innerHTML = '<div class="error">该投资组合暂无资产</div>';
                return;
            }
            
            const totalValue = allocationData.total;
            
            assetsData.forEach(asset => {
                let assetName = '';
                let assetValue = 0;
                let assetType = '';
                
                if (asset.stock) {
                    assetName = `${asset.stock.name} (${asset.stock.ticker})`;
                    assetValue = asset.quantity * asset.stock.current_price;
                    assetType = 'Stock';
                } else if (asset.cash) {
                    assetName = `${asset.cash.bank_name}`;
                    assetValue = asset.quantity;
                    assetType = 'Cash';
                }
                
                const percentage = totalValue > 0 ? (assetValue / totalValue) * 100 : 0;
                
                const assetElement = document.createElement('div');
                assetElement.className = 'asset-item';
                assetElement.innerHTML = `
                    <div class="asset-info">
                        <div class="asset-name">${assetName}</div>
                        <div class="asset-type">${assetType}</div>
                    </div>
                    <div class="asset-stats">
                        <div class="asset-value">$${assetValue.toLocaleString()}</div>
                        <div class="asset-percentage">${percentage.toFixed(1)}%</div>
                    </div>
                `;
                container.appendChild(assetElement);
            });
        }

        // 加载所有资产汇总
        async function loadAllAssets() {
            try {
                const response = await fetch(`${API_BASE}/all-assets`);
                const data = await response.json();
                
                // 计算收益率（使用真实数据）
                const totalAssets = data.total_assets;
                const previousTotal = data.previous_total; // 前一天资产
                const purchaseTotal = data.purchase_total; // 购买时资产

                const totalReturn = ((totalAssets - purchaseTotal) / purchaseTotal) * 100;
                const dailyReturn = ((totalAssets - previousTotal) / previousTotal) * 100;

                // 更新显示
                document.getElementById('total-return').textContent = `${totalReturn.toFixed(2)}%`;
                document.getElementById('daily-return').textContent = `${dailyReturn.toFixed(2)}%`;

                // 更新变化率
                const cashChange = 0;
                const stocksChange = dailyReturn;
                const totalChange = stocksChange;
                console.log(stocksChange, totalChange);

                
                document.getElementById('stocks-change').textContent = `${stocksChange > 0 ? '+' : ''}${stocksChange.toFixed(2)}%`;
                document.getElementById('stocks-change').className = `total-change ${stocksChange >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('total-change').textContent = `${totalChange > 0 ? '+' : ''}${totalChange.toFixed(2)}%`;
                document.getElementById('total-change').className = `total-change ${totalChange >= 0 ? 'positive' : 'negative'}`;
                
            } catch (error) {
                console.error('加载资产汇总失败:', error);
            }
        }

        // 更新总资产
        function updateTotalAssets() {
            const totalCash = parseFloat(document.getElementById('total-cash').textContent.replace('$', '').replace(',', '')) || 0;
            const totalStocks = parseFloat(document.getElementById('total-stocks').textContent.replace('$', '').replace(',', '')) || 0;
            const total = totalCash + totalStocks;
            document.getElementById('total-assets').textContent = `$${total.toLocaleString()}`;
        }
    </script>
</body>
</html> 